import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import javax.swing.*;
import javax.swing.event.*;
import java.awt.*;
import java.awt.event.*;
import java.net.URI;

public class TimeCalculator extends JFrame {
    private JLabel currentTimeLabel;
    private JPanel intervalsPanel;
    private JScrollPane intervalsScrollPane;
    private List<JTextField> intervalFields = new ArrayList<>();
    private List<JLabel> intervalLabels = new ArrayList<>();
    private JButton addButton;
    private JButton removeButton;
    private JButton calcControlButton;
    private JLabel resultLabel;
    private JLabel warningLabel;
    private JLabel etaLabel;
    private JLabel lastChangeLabel;

    private static final LocalTime CUTOFF_3PM = LocalTime.of(15, 0);
    private static final LocalTime CUTOFF_5PM = LocalTime.of(17, 0);
    private static final LocalTime CUTOFF_7PM = LocalTime.of(19, 0);

    private final DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("hh:mm:ss a");
    private final DateTimeFormatter zoneFormatter = DateTimeFormatter.ofPattern("z");

    private int intervalCount = 1;
    private javax.swing.Timer countdownTimer;
    private ZonedDateTime orderChangeTimeZoned = null;
    private boolean countdownActive = false;
    private boolean isPaused = false;
    private boolean hasStarted = false;
    private String lastChangeTimeText = "";

    // === URLs ===
    private static final String URL_CLOCK_IN = "https://wfmprod.ipaper.com/etm/";
    private static final String URL_UPDATE_PASSWORD = "https://myaccess.ipaper.com/identityiq/login.jsf?prompt=true";
    private static final String URL_WEATHER = "https://www.accuweather.com/en/us/louisville/40202/hourly-weather-forecast/348428";
    private static final String URL_IP_HOME = "https://ipapercloud.sharepoint.com/sites/ipnet";
    private static final String URL_MY_IP = "https://ppi.ipaper.com/";
    private static final String URL_SECRET_GROK = "https://grok.com/c";
    private static final String URL_SECRET_GITHUB = "https://github.com/RavenWare-Software-Solutions/Free-Software";

    public TimeCalculator() {
        setTitle("Time Calculator");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setAutoRequestFocus(true);

        JPanel topPanel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(2, 5, 2, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        ZonedDateTime now = ZonedDateTime.now();
        currentTimeLabel = new JLabel("Current Time: " + now.format(timeFormatter) + " " + now.format(zoneFormatter));
        currentTimeLabel.setToolTipText("Time is synced with your computer's system clock.");
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 3; gbc.anchor = GridBagConstraints.CENTER;
        topPanel.add(currentTimeLabel, gbc);

        javax.swing.Timer clockTimer = new javax.swing.Timer(1000, e -> {
            updateCurrentTime();
            calculateResult();
        });
        clockTimer.setInitialDelay(1000 - (now.getNano() / 1_000_000));
        clockTimer.start();

        countdownTimer = new javax.swing.Timer(1000, e -> updateCountdown());

        lastChangeLabel = new JLabel(" ");
        lastChangeLabel.setForeground(Color.BLUE.darker());
        lastChangeLabel.setFont(new Font("SansSerif", Font.BOLD, 12));
        gbc.gridy = 1; gbc.gridwidth = 3;
        topPanel.add(lastChangeLabel, gbc);

        etaLabel = new JLabel("Next order change in: --:--");
        etaLabel.setForeground(Color.BLUE.darker());
        etaLabel.setFont(new Font("SansSerif", Font.BOLD, 12));
        gbc.gridy = 2;
        topPanel.add(etaLabel, gbc);

        calcControlButton = new JButton("Calculate");
        calcControlButton.setFocusable(false);
        gbc.gridy = 3;
        topPanel.add(calcControlButton, gbc);

        calcControlButton.addActionListener(e -> {
            if (!hasStarted) {
                hasStarted = true;
                startCountdownFromField();
            } else if (countdownTimer.isRunning()) {
                stopCountdown();
            } else {
                startCountdownFromField();
            }
        });

        resultLabel = new JLabel("Resulting Time: ");
        gbc.gridy = 4;
        topPanel.add(resultLabel, gbc);

        warningLabel = new JLabel(" ");
        warningLabel.setForeground(Color.RED);
        gbc.gridy = 5;
        topPanel.add(warningLabel, gbc);

        intervalsPanel = new JPanel(new GridBagLayout());
        intervalsPanel.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));
        intervalsScrollPane = new JScrollPane(intervalsPanel);
        intervalsScrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
        intervalsScrollPane.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED);
        intervalsScrollPane.setPreferredSize(new Dimension(360, 300));

        JPanel southPanel = new JPanel(new BorderLayout());
        southPanel.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));

        JPanel topButtonPanel = new JPanel(new GridLayout(2, 2, 10, 10));
        topButtonPanel.add(createLinkButton("Clock In", URL_CLOCK_IN));
        topButtonPanel.add(createLinkButton("Update Password", URL_UPDATE_PASSWORD));
        topButtonPanel.add(createLinkButton("Weather", URL_WEATHER));
        topButtonPanel.add(createLinkButton("IP Home", URL_IP_HOME));
        southPanel.add(topButtonPanel, BorderLayout.NORTH);

        JPanel myIpPanel = new JPanel(new BorderLayout());
        myIpPanel.setBorder(BorderFactory.createEmptyBorder(12, 0, 0, 0));
        JPanel centerWrapper = new JPanel(new GridBagLayout());
        JButton myIpBtn = createLinkButton("MyIp", URL_MY_IP);
        myIpBtn.setPreferredSize(new Dimension(180, 36));
        centerWrapper.add(myIpBtn);
        myIpPanel.add(centerWrapper, BorderLayout.CENTER);
        southPanel.add(myIpPanel, BorderLayout.CENTER);

        JPanel secretPanel = new JPanel(new GridLayout(1, 2, 10, 0));
        secretPanel.setBorder(BorderFactory.createEmptyBorder(5, 40, 5, 40));
        JButton grokSecretBtn = createSecretButton(URL_SECRET_GROK);
        JButton githubSecretBtn = createSecretButton(URL_SECRET_GITHUB);
        secretPanel.add(grokSecretBtn);
        secretPanel.add(githubSecretBtn);
        southPanel.add(secretPanel, BorderLayout.SOUTH);

        JPanel mainContent = new JPanel(new BorderLayout());
        mainContent.add(topPanel, BorderLayout.NORTH);
        mainContent.add(intervalsScrollPane, BorderLayout.CENTER);

        setLayout(new BorderLayout());
        add(mainContent, BorderLayout.CENTER);
        add(southPanel, BorderLayout.SOUTH);

        addPlusButton();
        addRemoveButton();
        addFirstInterval();

        setPreferredSize(new Dimension(380, 780));
        pack();
        setLocationRelativeTo(null);
        setMinimumSize(new Dimension(380, 600));

        SwingUtilities.invokeLater(() -> {
            intervalFields.get(0).requestFocusInWindow();
            scrollToBottom(intervalsScrollPane);
        });

        calculateResult();
    }

    private JButton createLinkButton(String text, String url) {
        JButton btn = new JButton(text);
        btn.setToolTipText("Open: " + url);
        btn.addActionListener(e -> openUrl(url));
        return btn;
    }

    private JButton createSecretButton(String url) {
        JButton btn = new JButton();
        btn.setContentAreaFilled(false);
        btn.setBorderPainted(false);
        btn.setFocusPainted(false);
        btn.setOpaque(false);
        btn.setPreferredSize(new Dimension(100, 40));
        btn.addActionListener(e -> openUrl(url));
        return btn;
    }

    private void openUrl(String url) {
        try {
            Desktop.getDesktop().browse(new URI(url));
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "Could not open link: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void addFirstInterval() {
        addIntervalRow(1);
    }

    private void addIntervalRow(int idx) {
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(2, 5, 2, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        int row = idx - 1;

        JLabel lbl = new JLabel("Interval " + idx + " (MM / HMM):");
        gbc.gridx = 0; gbc.gridy = row; gbc.weightx = 0;
        intervalsPanel.add(lbl, gbc);  // FIXED: Removed "possibles" garbage
        intervalLabels.add(lbl);

        JTextField field = new JTextField();
        field.setColumns(8);
        field.setHorizontalAlignment(JTextField.RIGHT);
        field.setMaximumSize(new Dimension(120, field.getPreferredSize().height));
        gbc.gridx = 1; gbc.weightx = 1;
        intervalsPanel.add(field, gbc);
        intervalFields.add(field);

        addLiveUpdate(field);
        setupFieldTabToPlus(field);

        revalidateControlButtonsPosition();
        intervalsPanel.revalidate();
        intervalsPanel.repaint();
        scrollToBottom(intervalsScrollPane);
    }

    private void addPlusButton() {
        addButton = new JButton("+");
        addButton.setMargin(new Insets(2, 8, 2, 8));
        addButton.setToolTipText("Add new interval (press Tab to add)");
        Action addAction = new AbstractAction() {
            @Override public void actionPerformed(ActionEvent e) {
                intervalCount++;
                addIntervalRow(intervalCount);
                calculateResult();
                SwingUtilities.invokeLater(() -> intervalFields.get(intervalFields.size() - 1).requestFocusInWindow());
            }
        };
        addButton.addActionListener(addAction);
        addButton.setFocusable(true);
        addButton.addKeyListener(new KeyAdapter() {
            @Override public void keyPressed(KeyEvent e) {
                if (e.getKeyCode() == KeyEvent.VK_SPACE || e.getKeyCode() == KeyEvent.VK_ENTER) {
                    addAction.actionPerformed(null);
                }
            }
        });
        addButton.addKeyListener(new KeyAdapter() {
            @Override public void keyPressed(KeyEvent e) {
                if (e.getKeyCode() == KeyEvent.VK_TAB && !e.isShiftDown()) {
                    e.consume();
                    addAction.actionPerformed(null);
                } else if (e.getKeyCode() == KeyEvent.VK_TAB && e.isShiftDown()) {
                    e.consume();
                    intervalFields.get(intervalFields.size() - 1).requestFocusInWindow();
                }
            }
        });
    }

    private void addRemoveButton() {
        removeButton = new JButton("-");
        removeButton.setMargin(new Insets(2, 6, 2, 6));
        removeButton.setToolTipText("Remove last interval");
        removeButton.setFont(new Font("SansSerif", Font.BOLD, 12));
        removeButton.setForeground(Color.GRAY.darker());
        removeButton.setFocusable(true);
        removeButton.addActionListener(e -> {
            if (intervalCount > 1) {
                intervalFields.remove(intervalFields.size() - 1);
                intervalLabels.remove(intervalLabels.size() - 1);
                intervalsPanel.remove(intervalsPanel.getComponentCount() - 1);
                intervalsPanel.remove(intervalsPanel.getComponentCount() - 1);
                intervalCount--;
                revalidateControlButtonsPosition();
                calculateResult();
            }
        });
    }

    private void revalidateControlButtonsPosition() {
        if (addButton.getParent() != null) intervalsPanel.remove(addButton);
        if (removeButton.getParent() != null) intervalsPanel.remove(removeButton);

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(2, 5, 2, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.gridx = 1; gbc.weightx = 1;

        gbc.gridy = intervalCount;
        intervalsPanel.add(addButton, gbc);

        if (intervalCount > 1) {
            gbc.gridy = intervalCount + 1;
            intervalsPanel.add(removeButton, gbc);
        }

        intervalsPanel.revalidate();
        intervalsPanel.repaint();
        scrollToBottom(intervalsScrollPane);
    }

    private void setupFieldTabToPlus(JTextField field) {
        field.addKeyListener(new KeyAdapter() {
            @Override public void keyPressed(KeyEvent e) {
                if (e.getKeyCode() == KeyEvent.VK_TAB && !e.isShiftDown()) {
                    e.consume();
                    addButton.requestFocusInWindow();
                }
            }
        });
    }

    private void addLiveUpdate(JTextField f) {
        f.getDocument().addDocumentListener(new DocumentListener() {
            public void insertUpdate(DocumentEvent e) { onFieldChanged(); }
            public void removeUpdate(DocumentEvent e) { onFieldChanged(); }
            public void changedUpdate(DocumentEvent e) { onFieldChanged(); }
        });
    }

    private void onFieldChanged() {
        calculateResult();
        if (isPaused && !intervalFields.isEmpty()) {
            updateCountdownTargetFromField();
        }
    }

    private void startCountdownFromField() {
        updateCountdownTargetFromField();
        if (orderChangeTimeZoned == null) {
            updateControlButtonState();
            return;
        }

        countdownTimer.start();
        countdownActive = true;
        isPaused = false;
        updateControlButtonState();
    }

    private void stopCountdown() {
        countdownTimer.stop();
        countdownActive = false;
        isPaused = true;
        updateCountdown();
        updateControlButtonState();
    }

    private void updateCountdownTargetFromField() {
        if (intervalFields.isEmpty()) {
            orderChangeTimeZoned = null;
            etaLabel.setText("Next order change in: --:--");
            return;
        }

        String txt = intervalFields.get(0).getText().trim();
        if (txt.isEmpty()) {
            orderChangeTimeZoned = null;
            etaLabel.setText("Next order change in: --:--");
            return;
        }

        int mins;
        try {
            mins = parseMinutes(txt);
        } catch (NumberFormatException ex) {
            orderChangeTimeZoned = null;
            etaLabel.setText("Next order change in: --:--");
            return;
        }

        orderChangeTimeZoned = ZonedDateTime.now().plusMinutes(mins);
        intervalFields.get(0).setText(String.valueOf(mins));
    }

    private void updateCountdown() {
        if (orderChangeTimeZoned == null) {
            etaLabel.setText("Next order change in: --:--");
            return;
        }

        ZonedDateTime now = ZonedDateTime.now();
        long remainingSec = Duration.between(now, orderChangeTimeZoned).getSeconds();

        if (remainingSec > 0) {
            long mins = remainingSec / 60;
            long secs = remainingSec % 60;
            intervalFields.get(0).setText(String.valueOf(mins));

            String countdownStr = String.format("%d:%02d", mins, secs);
            String changeAtStr = orderChangeTimeZoned.format(timeFormatter);
            etaLabel.setText(String.format(
                "<html>Next order change in: <b>%s</b> <font color='#555555'>/ at %s</font></html>",
                countdownStr, changeAtStr));
        } else {
            String changeTime = orderChangeTimeZoned.format(timeFormatter);
            lastChangeTimeText = "Order changed at: " + changeTime;
            lastChangeLabel.setText("<html><b><font color='blue'>" + lastChangeTimeText + "</font></b></html>");
            etaLabel.setText("<html><b>Order changed at " + changeTime + "</b></html>");

            shiftIntervalsUp();
            updateCountdownTargetFromField();
            if (countdownActive && !isPaused) {
                startCountdownFromField();
            }
        }
    }

    private void updateControlButtonState() {
        if (!hasStarted) {
            calcControlButton.setText("Calculate");
            calcControlButton.setForeground(UIManager.getColor("Button.foreground"));
            calcControlButton.setToolTipText("Start countdown from Interval 1");
        } else if (countdownTimer.isRunning()) {
            calcControlButton.setText("Calculate Stop");
            calcControlButton.setForeground(Color.RED.darker());
            calcControlButton.setToolTipText("Stop countdown and edit Interval 1");
        } else {
            calcControlButton.setText("Calculate Resume");
            calcControlButton.setForeground(Color.GREEN.darker());
            calcControlButton.setToolTipText("Resume countdown using current Interval 1 value");
        }
    }

    private void updateCurrentTime() {
        ZonedDateTime now = ZonedDateTime.now();  // FIXED: Was now768() → invalid
        currentTimeLabel.setText("Current Time: " + now.format(timeFormatter) + " " + now.format(zoneFormatter));
    }

    private void shiftIntervalsUp() {
        if (intervalFields.size() <= 1) {
            intervalFields.get(0).setText("");
            orderChangeTimeZoned = null;
            calculateResult();
            return;
        }

        List<String> values = new ArrayList<>();
        for (JTextField f : intervalFields) values.add(f.getText().trim());

        intervalsPanel.removeAll();
        intervalFields.clear();
        intervalLabels.clear();
        intervalCount = 0;

        for (int i = 1; i < values.size(); i++) {
            intervalCount++;
            addIntervalRow(intervalCount);
            intervalFields.get(intervalFields.size() - 1).setText(values.get(i));
        }

        if (intervalCount == 0) {
            intervalCount = 1;
            addIntervalRow(1);
            intervalFields.get(0).setText("");
        }

        revalidateControlButtonsPosition();
        calculateResult();
    }

    private String formatDuration(long minutes) {
        if (minutes < 60) return minutes + " min";
        long hrs = minutes / 60;
        long mins = minutes % 60;
        return hrs + " hr" + (mins > 0 ? " " + mins + " min" : "");
    }

    private void calculateResult() {
        LocalTime now = LocalTime.now();
        long total = 0;
        boolean hasError = false;

        for (JTextField f : intervalFields) {
            String txt = f.getText().trim();
            if (txt.isEmpty()) continue;
            try {
                total += parseMinutes(txt);
            } catch (NumberFormatException e) {
                hasError = true;
                break;
            }
        }

        if (hasError) {
            resultLabel.setText("<html><font color='red'>Invalid input – check fields</font></html>");
            warningLabel.setText("");
            updateControlButtonState();
            return;
        }

        LocalTime finalTime = now.plusMinutes(total);
        String cutoff = "";
        long excess = 0;
        int breach = -1;

        if (finalTime.isAfter(CUTOFF_7PM) && now.compareTo(CUTOFF_7PM) <= 0) {
            cutoff = "7:00 PM"; excess = Duration.between(CUTOFF_7PM, finalTime).toMinutes();
        } else if (finalTime.isAfter(CUTOFF_5PM) && now.compareTo(CUTOFF_5PM) <= 0) {
            cutoff = "5:00 PM"; excess = Duration.between(CUTOFF_5PM, finalTime).toMinutes();
        } else if (finalTime.isAfter(CUTOFF_3PM) && now.compareTo(CUTOFF_3PM) <= 0) {
            cutoff = "3:00 PM"; excess = Duration.between(CUTOFF_3PM, finalTime).toMinutes();
        }

        if (!cutoff.isEmpty()) {
            long cum = 0;
            LocalTime cut = cutoff.contains("3:00") ? CUTOFF_3PM :
                           cutoff.contains("5:00") ? CUTOFF_5PM : CUTOFF_7PM;
            for (int i = 0; i < intervalFields.size(); i++) {
                String txt = intervalFields.get(i).getText().trim();
                if (txt.isEmpty()) continue;
                try {
                    int m = parseMinutes(txt);
                    cum += m;
                    if (now.plusMinutes(cum).isAfter(cut) && now.compareTo(cut) <= 0) {
                        breach = i + 1; break;
                    }
                } catch (NumberFormatException e) { hasError = true; break; }
            }
        }

        if (hasError) {
            resultLabel.setText("<html><font color='red'>Invalid input – check fields</font></html>");
            warningLabel.setText("");
        } else {
            resultLabel.setText("Resulting Time: " + finalTime.format(timeFormatter) +
                    " (Added " + formatDuration(total) + ")");

            if (breach != -1) {
                warningLabel.setText("<html><b>Warning:</b> exceeds " + cutoff +
                        " at Interval " + breach + " by " + formatDuration(excess) + "</html>");
            } else {
                warningLabel.setText("");
            }
        }

        updateControlButtonState();
    }

    private int parseMinutes(String txt) throws NumberFormatException {
        if (txt.matches("\\d{3}")) {
            int val = Integer.parseInt(txt);
            int h = val / 100, m = val % 100;
            if (h >= 10 || m >= 60) throw new NumberFormatException();
            return h * 60 + m;
        }
        return Integer.parseInt(txt);
    }

    private void scrollToBottom(JScrollPane sp) {
        SwingUtilities.invokeLater(() -> {
            JScrollBar vb = sp.getVerticalScrollBar();
            vb.setValue(vb.getMaximum());
        });
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            try { UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName()); }
            catch (Exception ignored) {}
            new TimeCalculator().setVisible(true);
        });
    }
}
